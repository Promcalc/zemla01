<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ ‚Äî –ö–∞—Ä—Ç–∞</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    #map { width: 100%; height: 100vh; }
    .popup-title { font-weight: bold; margin-bottom: 6px; }
    .popup-desc { font-size: 14px; margin-bottom: 8px; color: #333; }
    .popup-link { color: #1976d2; text-decoration: none; }
    .popup-link:hover { text-decoration: underline; }

    .popup-lot {
      margin-bottom: 8px;
    }
    .popup-lot:last-child {
      margin-bottom: 0;
    }
    .popup-lot hr {
      margin: 12px 0;
      border: 0;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
ymaps.ready(init);

function escapeHtml(str) {
  if (typeof str !== 'string') return str == null ? '' : String(str);
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "<")
    .replace(/>/g, ">")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function init() {
  const map = new ymaps.Map("map", {
    center: [55.830431, 49.066143], // –ö–∞–∑–∞–Ω—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    zoom: 10,
    controls: ['zoomControl', 'searchControl']
  });

  const clusterer = new ymaps.Clusterer({
    preset: 'islands#invertedVioletClusterIcons',
    clusterDisableClickZoom: false,
    clusterOpenBalloonOnClick: true
  });

  fetch('http://localhost:8080/api/points')
    .then(response => {
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      return response.json();
    })
    .then(lots => {
      // üîπ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
      const groups = new Map(); // –∫–ª—é—á: "lat,lon", –∑–Ω–∞—á–µ–Ω–∏–µ: LotPoint[]

      lots.forEach(lot => {
        if (typeof lot.lat !== 'number' || typeof lot.lon !== 'number') return;
        const key = `${lot.lat.toFixed(6)},${lot.lon.toFixed(6)}`; // —Ç–æ—á–Ω–æ—Å—Ç—å –¥–æ 6 –∑–Ω–∞–∫–æ–≤
        if (!groups.has(key)) {
          groups.set(key, []);
        }
        groups.get(key).push(lot);
      });

      // üîπ –°–æ–∑–¥–∞—ë–º –ø–æ –æ–¥–Ω–æ–π –º–µ—Ç–∫–µ –Ω–∞ –≥—Ä—É–ø–ø—É
      const placemarks = Array.from(groups.entries()).map(([key, lotGroup]) => {
        const [latStr, lonStr] = key.split(',');
        const lat = parseFloat(latStr);
        const lon = parseFloat(lonStr);

        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—â–∏–π –±–∞–ª—É–Ω —Å–æ –≤—Å–µ–º–∏ –ª–æ—Ç–∞–º–∏
        const balloonContent = lotGroup.map(lot => `
          <div class="popup-lot">
            <div class="popup-title">${escapeHtml(lot.lotName)}</div>
            <div class="popup-desc">${escapeHtml(lot.lotDescription)}</div>
            <a class="popup-link" href="${escapeHtml(lot.link)}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ Google –¢–∞–±–ª–∏—Ü–µ</a>
          </div>
          <hr style="margin:12px 0; border:0; border-top:1px solid #eee;">
        `).join('');

        // –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π <hr>
        const cleanBalloon = balloonContent.replace(/<hr[^>]*>$/, '');

        return new ymaps.Placemark(
          [lat, lon],
          {
            balloonContent: cleanBalloon,
            hintContent: `–õ–æ—Ç–æ–≤: ${lotGroup.length}`
          },
          {
            preset: lotGroup.length > 1 
              ? 'islands#redDotIcon' 
              : 'islands#violetDotIconWithCaption',
            iconCaption: lotGroup.length > 1 ? String(lotGroup.length) : undefined
          }
        );
      });

      clusterer.add(placemarks);
      map.geoObjects.add(clusterer);

      // –ê–≤—Ç–æ—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–º —Ç–æ—á–∫–∞–º
      if (lots.length > 0) {
        const points = lots.map(l => [l.lat, l.lon]);
        map.setBounds(ymaps.util.bounds.fromPoints(points), { zoomMargin: 40 });
      }
    })
    .catch(err => {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ—Ç—ã');
    });
}
  </script>
</body>
</html>