<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ó–µ–º–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ ‚Äî –ö–∞—Ä—Ç–∞</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
  <style>
    #map { width: 100%; height: 100vh; }
    .popup-title { font-weight: bold; margin-bottom: 6px; }
    .popup-desc { font-size: 14px; margin-bottom: 8px; color: #333; }
    .popup-link { color: #1976d2; text-decoration: none; }
    .popup-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    function escapeHtml(str) {
      if (typeof str !== 'string') return str == null ? '' : String(str);
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

//    const lots = [
//      {
//        lat: 55.526037,
//        lon: 49.516702,
//        lotName: "–ª–æ—Ç 7 –ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞ ‚Äì 1335 –∫–≤.–º., –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –†–¢, –õ–∞–∏—à–µ–≤—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω...",
//        lotDescription: "–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞ ‚Äì 1335 –∫–≤.–º., –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –†–¢, –õ–∞–∏—à–µ–≤—Å–∫–∏–π –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π —Ä–∞–π–æ–Ω, –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤—Å–∫–æ–µ —Å–µ–ª—å—Å–∫–æ–µ –ø–æ—Å–µ–ª–µ–Ω–∏–µ, —Å.–ë—É—Ç—ã—Ä–∏...",
//        link: "https://docs.google.com/spreadsheets/d/1abc123/edit#gid=0&range=A7"
//      }
//    ];


// –í–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ lots:
let lots = [];

    ymaps.ready(init);

    function init() {
      const map = new ymaps.Map("map", {
        center: [55.526, 49.516],
        zoom: 14,
        controls: ['zoomControl']
      });

    fetch('http://localhost:8080/api/points')
      .then(response => {
        if (!response.ok) throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
        return response.json();
      })
      .then(data => {
        lots = data;
        // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥: —Å–æ–∑–¥–∞–Ω–∏–µ placemarks, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä –∏ —Ç.–¥.

        const clusterer = new ymaps.Clusterer({
          preset: 'islands#invertedVioletClusterIcons'
        });

        const placemarks = lots.map(lot => {
          return new ymaps.Placemark(
            [lot.lat, lot.lon],
            {
              balloonContent: `
                <div class="popup-title">${escapeHtml(lot.lotName)}</div>
                <div class="popup-desc">${escapeHtml(lot.lotDescription)}</div>
                <a class="popup-link" href="${escapeHtml(lot.link)}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ Google –¢–∞–±–ª–∏—Ü–µ</a>
              `,
              hintContent: escapeHtml(lot.lotName)
            },
            {
              preset: 'islands#violetDotIconWithCaption'
            }
          );
        });
  
        clusterer.add(placemarks);
        map.geoObjects.add(clusterer);

      })
      .catch(err => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–æ–≤:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞');
      });

    }
  </script>
</body>
</html>